<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus PhotoShop - Online Image Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo i {
            color: var(--accent-color);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        nav a:hover {
            color: var(--accent-color);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
            margin: 30px 0;
        }

        .sidebar {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            max-height: 800px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: var(--secondary-color);
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: var(--light-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .tool-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .tool-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .filter-btn {
            padding: 10px;
            background-color: var(--light-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .editor-area {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-section {
            width: 100%;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .upload-btn {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background-color: #2980b9;
        }

        .url-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            font-size: 1rem;
        }

        .canvas-container {
            width: 100%;
            height: 500px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: hidden;
            background-color: #f9f9f9;
            position: relative;
        }

        #imageCanvas {
            max-width: 100%;
            max-height: 100%;
        }

        .editor-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .control-btn:hover {
            background-color: #1a252f;
        }

        .control-btn.save {
            background-color: var(--accent-color);
        }

        .control-btn.save:hover {
            background-color: #c0392b;
        }

        .slider-container {
            width: 100%;
            margin: 15px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        footer {
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
        }

        /* Crop overlay */
        .crop-overlay {
            position: absolute;
            border: 2px dashed var(--accent-color);
            background-color: rgba(52, 152, 219, 0.2);
            cursor: move;
            display: none;
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }

        .handle-nw { top: -5px; left: -5px; cursor: nw-resize; }
        .handle-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .handle-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .handle-se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Adjustment controls */
        .adjustment-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .adjustment-slider {
            margin-bottom: 15px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .editor-area {
                order: 1;
            }
            
            .adjustment-controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .upload-options {
                flex-direction: column;
                align-items: center;
            }
            
            .url-input {
                width: 100%;
                max-width: 300px;
            }
            
            .editor-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .placeholder-text {
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        .dimension-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .dimension-inputs input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .apply-crop-btn {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-palette"></i>
                    <span>Nexus PhotoShop</span>
                </div>
                <nav>
                    <ul>
                        <li><a href="#"><i class="fas fa-home"></i> Home</a></li>
                        <li><a href="#"><i class="fas fa-info-circle"></i> About</a></li>
                        <li><a href="#"><i class="fas fa-question-circle"></i> Help</a></li>
                        <li><a href="#"><i class="fas fa-envelope"></i> Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-sliders-h"></i> Adjustments</h3>
                    <div class="adjustment-controls">
                        <div class="adjustment-slider">
                            <label for="brightnessSlider">Brightness</label>
                            <input type="range" min="0" max="200" value="100" class="slider" id="brightnessSlider">
                            <span id="brightnessValue">100%</span>
                        </div>
                        <div class="adjustment-slider">
                            <label for="contrastSlider">Contrast</label>
                            <input type="range" min="0" max="200" value="100" class="slider" id="contrastSlider">
                            <span id="contrastValue">100%</span>
                        </div>
                        <div class="adjustment-slider">
                            <label for="saturationSlider">Saturation</label>
                            <input type="range" min="0" max="200" value="100" class="slider" id="saturationSlider">
                            <span id="saturationValue">100%</span>
                        </div>
                        <div class="adjustment-slider">
                            <label for="blurSlider">Blur</label>
                            <input type="range" min="0" max="10" value="0" class="slider" id="blurSlider">
                            <span id="blurValue">0px</span>
                        </div>
                    </div>
                    <button class="tool-btn" id="rotateBtn">
                        <i class="fas fa-redo"></i> Rotate Image
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-expand-alt"></i> Scale</h3>
                    <div class="slider-container">
                        <label for="scaleSlider">Scale: <span id="scaleValue">100%</span></label>
                        <input type="range" min="10" max="200" value="100" class="slider" id="scaleSlider">
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    <div class="filter-grid">
                        <button class="filter-btn" data-filter="grayscale">Grayscale</button>
                        <button class="filter-btn" data-filter="sepia">Sepia</button>
                        <button class="filter-btn" data-filter="invert">Invert</button>
                        <button class="filter-btn" data-filter="vintage">Vintage</button>
                        <button class="filter-btn" data-filter="cool">Cool</button>
                        <button class="filter-btn" data-filter="warm">Warm</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-crop-alt"></i> Crop & Resize</h3>
                    <button class="tool-btn" id="cropBtn">
                        <i class="fas fa-crop-alt"></i> Crop Image
                    </button>
                    <button class="tool-btn" id="resizeBtn">
                        <i class="fas fa-expand-arrows-alt"></i> Resize
                    </button>
                    
                    <div id="cropControls" class="hidden">
                        <div class="dimension-inputs">
                            <input type="number" id="cropWidth" placeholder="Width">
                            <input type="number" id="cropHeight" placeholder="Height">
                        </div>
                        <button class="apply-crop-btn" id="applyCropBtn">Apply Crop</button>
                    </div>
                    
                    <div id="resizeControls" class="hidden">
                        <div class="dimension-inputs">
                            <input type="number" id="resizeWidth" placeholder="Width">
                            <input type="number" id="resizeHeight" placeholder="Height">
                        </div>
                        <button class="apply-crop-btn" id="applyResizeBtn">Apply Resize</button>
                    </div>
                </div>
            </aside>

            <main class="editor-area">
                <div class="upload-section">
                    <h2>Edit Your Images with Nexus PhotoShop</h2>
                    <p>Upload an image or paste a URL to get started</p>
                    
                    <div class="upload-options">
                        <input type="text" class="url-input" placeholder="Paste image URL here">
                        <button class="upload-btn" id="loadUrlBtn">Load from URL</button>
                        <button class="upload-btn" id="uploadBtn"><i class="fas fa-upload"></i> Upload Image</button>
                        <input type="file" id="fileInput" accept="image/*" class="hidden">
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="imageCanvas">
                        Your browser does not support the canvas element.
                    </canvas>
                    <div id="cropOverlay" class="crop-overlay">
                        <div class="crop-handle handle-nw"></div>
                        <div class="crop-handle handle-ne"></div>
                        <div class="crop-handle handle-sw"></div>
                        <div class="crop-handle handle-se"></div>
                    </div>
                    <div id="placeholder" class="placeholder-text">
                        <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>Your image will appear here</p>
                    </div>
                </div>

                <div class="editor-controls">
                    <button class="control-btn" id="resetBtn"><i class="fas fa-undo"></i> Reset</button>
                    <button class="control-btn" id="downloadBtn"><i class="fas fa-download"></i> Download</button>
                    <button class="control-btn save" id="saveBtn"><i class="fas fa-save"></i> Save to Cloud</button>
                </div>
            </main>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2023 Nexus PhotoShop. All rights reserved.</p>
            <p>Beginner-friendly online image editor</p>
        </div>
    </footer>

    <script>
        // Backend API Configuration
        const API_BASE_URL = 'http://localhost:5000';
        
        // DOM Elements
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const urlInput = document.querySelector('.url-input');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const saveBtn = document.getElementById('saveBtn');
        const placeholder = document.getElementById('placeholder');
        
        // Adjustment sliders
        const brightnessSlider = document.getElementById('brightnessSlider');
        const contrastSlider = document.getElementById('contrastSlider');
        const saturationSlider = document.getElementById('saturationSlider');
        const blurSlider = document.getElementById('blurSlider');
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastValue = document.getElementById('contrastValue');
        const saturationValue = document.getElementById('saturationValue');
        const blurValue = document.getElementById('blurValue');
        
        // Scale slider
        const scaleSlider = document.getElementById('scaleSlider');
        const scaleValue = document.getElementById('scaleValue');
        
        // Tool buttons
        const rotateBtn = document.getElementById('rotateBtn');
        const cropBtn = document.getElementById('cropBtn');
        const resizeBtn = document.getElementById('resizeBtn');
        
        // Crop & Resize elements
        const cropControls = document.getElementById('cropControls');
        const resizeControls = document.getElementById('resizeControls');
        const cropOverlay = document.getElementById('cropOverlay');
        const cropWidth = document.getElementById('cropWidth');
        const cropHeight = document.getElementById('cropHeight');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const resizeWidth = document.getElementById('resizeWidth');
        const resizeHeight = document.getElementById('resizeHeight');
        const applyResizeBtn = document.getElementById('applyResizeBtn');
        
        // Filter buttons
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // State variables
        let originalImage = null;
        let currentImage = null;
        let rotation = 0;
        let isCropping = false;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropWidthValue = 0;
        let cropHeightValue = 0;
        let scale = 1.0;
        
        // Adjustment values
        let adjustments = {
            brightness: 100,
            contrast: 100,
            saturation: 100,
            blur: 0
        };
        
        // Initialize
        function init() {
            // Set up event listeners
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleImageUpload);
            loadUrlBtn.addEventListener('click', loadImageFromUrl);
            resetBtn.addEventListener('click', resetImage);
            downloadBtn.addEventListener('click', downloadImage);
            saveBtn.addEventListener('click', saveImage);
            
            // Adjustment sliders
            brightnessSlider.addEventListener('input', updateBrightness);
            contrastSlider.addEventListener('input', updateContrast);
            saturationSlider.addEventListener('input', updateSaturation);
            blurSlider.addEventListener('input', updateBlur);
            
            // Scale slider
            scaleSlider.addEventListener('input', applyScale);
            
            // Tool buttons
            rotateBtn.addEventListener('click', rotateImage);
            cropBtn.addEventListener('click', () => activateTool('crop'));
            resizeBtn.addEventListener('click', () => activateTool('resize'));
            
            // Crop & Resize controls
            applyCropBtn.addEventListener('click', applyCrop);
            applyResizeBtn.addEventListener('click', applyResize);
            
            // Filter buttons
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => applyFilter(btn.dataset.filter));
            });
            
            // Crop overlay events
            setupCropOverlay();
            
            // Initially hide controls
            cropControls.classList.add('hidden');
            resizeControls.classList.add('hidden');
        }
        
        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImage(event.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        // Load image from URL
        function loadImageFromUrl() {
            const url = urlInput.value.trim();
            if (!url) {
                alert('Please enter a valid image URL');
                return;
            }
            
            loadImage(url);
        }
        
        // Load image and display on canvas
        function loadImage(src) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                originalImage = img;
                currentImage = img;
                displayImage();
                placeholder.classList.add('hidden');
                
                // Set initial crop dimensions
                cropWidth.value = img.width;
                cropHeight.value = img.height;
                resizeWidth.value = img.width;
                resizeHeight.value = img.height;
                
                // Reset adjustments
                resetAdjustments();
            };
            img.onerror = function() {
                alert('Failed to load image. Please check the URL or try a different image.');
            };
            img.src = src;
        }
        
        // Display image on canvas with all adjustments applied
        function displayImage() {
            if (!currentImage) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set canvas dimensions to match image
            canvas.width = currentImage.width * scale;
            canvas.height = currentImage.height * scale;
            
            // Apply all adjustments as a filter
            ctx.filter = `
                brightness(${adjustments.brightness}%) 
                contrast(${adjustments.contrast}%) 
                saturate(${adjustments.saturation}%) 
                blur(${adjustments.blur}px)
            `;
            
            // Apply rotation if needed
            if (rotation !== 0) {
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.drawImage(currentImage, -currentImage.width * scale / 2, -currentImage.height * scale / 2, 
                             currentImage.width * scale, currentImage.height * scale);
                ctx.restore();
            } else {
                ctx.drawImage(currentImage, 0, 0, currentImage.width * scale, currentImage.height * scale);
            }
            
            // Reset filter for next operations
            ctx.filter = 'none';
        }
        
        // Update brightness
        function updateBrightness() {
            adjustments.brightness = parseInt(brightnessSlider.value);
            brightnessValue.textContent = `${adjustments.brightness}%`;
            displayImage();
        }
        
        // Update contrast
        function updateContrast() {
            adjustments.contrast = parseInt(contrastSlider.value);
            contrastValue.textContent = `${adjustments.contrast}%`;
            displayImage();
        }
        
        // Update saturation
        function updateSaturation() {
            adjustments.saturation = parseInt(saturationSlider.value);
            saturationValue.textContent = `${adjustments.saturation}%`;
            displayImage();
        }
        
        // Update blur
        function updateBlur() {
            adjustments.blur = parseInt(blurSlider.value);
            blurValue.textContent = `${adjustments.blur}px`;
            displayImage();
        }
        
        // Apply scale to image
        function applyScale() {
            scale = scaleSlider.value / 100;
            scaleValue.textContent = `${scaleSlider.value}%`;
            displayImage();
        }
        
        // Rotate image
        function rotateImage() {
            rotation += 90;
            if (rotation >= 360) rotation = 0;
            displayImage();
        }
        
        // Reset all adjustments to default values
        function resetAdjustments() {
            adjustments = {
                brightness: 100,
                contrast: 100,
                saturation: 100,
                blur: 0
            };
            
            brightnessSlider.value = 100;
            contrastSlider.value = 100;
            saturationSlider.value = 100;
            blurSlider.value = 0;
            
            brightnessValue.textContent = '100%';
            contrastValue.textContent = '100%';
            saturationValue.textContent = '100%';
            blurValue.textContent = '0px';
            
            scale = 1.0;
            scaleSlider.value = 100;
            scaleValue.textContent = '100%';
            
            rotation = 0;
        }
        
        // Activate a tool
        function activateTool(tool) {
            // Show/hide appropriate controls
            cropControls.classList.add('hidden');
            resizeControls.classList.add('hidden');
            cropOverlay.style.display = 'none';
            
            // Set controls based on tool
            switch(tool) {
                case 'crop':
                    cropControls.classList.remove('hidden');
                    cropOverlay.style.display = 'block';
                    setupCropOverlay();
                    break;
                case 'resize':
                    resizeControls.classList.remove('hidden');
                    break;
            }
        }
        
        // Apply filter to image
        function applyFilter(filter) {
            if (!originalImage) return;
            
            // Create a temporary canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            
            // Apply filter
            let filterValue = '';
            switch(filter) {
                case 'grayscale':
                    filterValue = 'grayscale(100%)';
                    break;
                case 'sepia':
                    filterValue = 'sepia(100%)';
                    break;
                case 'invert':
                    filterValue = 'invert(100%)';
                    break;
                case 'vintage':
                    filterValue = 'sepia(50%) contrast(120%) brightness(90%)';
                    break;
                case 'cool':
                    filterValue = 'hue-rotate(180deg) saturate(150%)';
                    break;
                case 'warm':
                    filterValue = 'hue-rotate(-30deg) saturate(150%)';
                    break;
            }
            
            tempCtx.filter = filterValue;
            tempCtx.drawImage(originalImage, 0, 0);
            
            // Update current image and display
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                displayImage();
            };
            img.src = tempCanvas.toDataURL();
        }
        
        // Setup crop overlay functionality
        function setupCropOverlay() {
            if (!currentImage) return;
            
            // Set initial crop overlay dimensions
            const container = document.querySelector('.canvas-container');
            const containerRect = container.getBoundingClientRect();
            
            cropOverlay.style.width = '200px';
            cropOverlay.style.height = '200px';
            cropOverlay.style.left = (containerRect.width / 2 - 100) + 'px';
            cropOverlay.style.top = (containerRect.height / 2 - 100) + 'px';
            
            // Update crop dimensions in inputs
            cropWidth.value = 200;
            cropHeight.value = 200;
            
            // Make crop overlay draggable and resizable
            makeDraggable(cropOverlay);
            makeResizable(cropOverlay);
        }
        
        // Make element draggable
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                const container = document.querySelector('.canvas-container');
                const containerRect = container.getBoundingClientRect();
                const elementRect = element.getBoundingClientRect();
                
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                
                // Constrain within container
                if (newTop < 0) newTop = 0;
                if (newLeft < 0) newLeft = 0;
                if (newTop + elementRect.height > containerRect.height) newTop = containerRect.height - elementRect.height;
                if (newLeft + elementRect.width > containerRect.width) newLeft = containerRect.width - elementRect.width;
                
                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
                
                // Update crop dimensions in inputs
                cropWidth.value = Math.round(elementRect.width);
                cropHeight.value = Math.round(elementRect.height);
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        // Make element resizable
        function makeResizable(element) {
            const handles = element.querySelectorAll('.crop-handle');
            
            handles.forEach(handle => {
                handle.addEventListener('mousedown', initResize);
            });
            
            function initResize(e) {
                e.preventDefault();
                
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
                const startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
                const startLeft = parseInt(document.defaultView.getComputedStyle(element).left, 10);
                const startTop = parseInt(document.defaultView.getComputedStyle(element).top, 10);
                
                document.onmousemove = doResize;
                document.onmouseup = stopResize;
                
                function doResize(e) {
                    const container = document.querySelector('.canvas-container');
                    const containerRect = container.getBoundingClientRect();
                    
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;
                    
                    if (e.target.classList.contains('handle-se')) {
                        newWidth = startWidth + (e.clientX - startX);
                        newHeight = startHeight + (e.clientY - startY);
                    } else if (e.target.classList.contains('handle-sw')) {
                        newWidth = startWidth - (e.clientX - startX);
                        newHeight = startHeight + (e.clientY - startY);
                        newLeft = startLeft + (e.clientX - startX);
                    } else if (e.target.classList.contains('handle-ne')) {
                        newWidth = startWidth + (e.clientX - startX);
                        newHeight = startHeight - (e.clientY - startY);
                        newTop = startTop + (e.clientY - startY);
                    } else if (e.target.classList.contains('handle-nw')) {
                        newWidth = startWidth - (e.clientX - startX);
                        newHeight = startHeight - (e.clientY - startY);
                        newLeft = startLeft + (e.clientX - startX);
                        newTop = startTop + (e.clientY - startY);
                    }
                    
                    // Constrain minimum size
                    if (newWidth < 50) newWidth = 50;
                    if (newHeight < 50) newHeight = 50;
                    
                    // Constrain within container
                    if (newLeft < 0) {
                        newWidth += newLeft;
                        newLeft = 0;
                    }
                    if (newTop < 0) {
                        newHeight += newTop;
                        newTop = 0;
                    }
                    if (newLeft + newWidth > containerRect.width) {
                        newWidth = containerRect.width - newLeft;
                    }
                    if (newTop + newHeight > containerRect.height) {
                        newHeight = containerRect.height - newTop;
                    }
                    
                    element.style.width = newWidth + 'px';
                    element.style.height = newHeight + 'px';
                    element.style.left = newLeft + 'px';
                    element.style.top = newTop + 'px';
                    
                    // Update crop dimensions in inputs
                    cropWidth.value = Math.round(newWidth);
                    cropHeight.value = Math.round(newHeight);
                }
                
                function stopResize() {
                    document.onmousemove = null;
                    document.onmouseup = null;
                }
            }
        }
        
        // Apply crop to image
        function applyCrop() {
            if (!currentImage) return;
            
            const container = document.querySelector('.canvas-container');
            const containerRect = container.getBoundingClientRect();
            const cropRect = cropOverlay.getBoundingClientRect();
            
            // Calculate crop coordinates relative to canvas
            const scaleX = currentImage.width / containerRect.width;
            const scaleY = currentImage.height / containerRect.height;
            
            const cropX = (cropRect.left - containerRect.left) * scaleX;
            const cropY = (cropRect.top - containerRect.top) * scaleY;
            const cropWidthPx = cropRect.width * scaleX;
            const cropHeightPx = cropRect.height * scaleY;
            
            // Create a temporary canvas for the cropped image
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = cropWidthPx;
            tempCanvas.height = cropHeightPx;
            
            // Draw the cropped portion
            tempCtx.drawImage(
                currentImage,
                cropX, cropY, cropWidthPx, cropHeightPx,
                0, 0, cropWidthPx, cropHeightPx
            );
            
            // Update current image and display
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                displayImage();
                
                // Hide crop overlay and controls
                cropOverlay.style.display = 'none';
                cropControls.classList.add('hidden');
                
                // Update resize inputs
                resizeWidth.value = img.width;
                resizeHeight.value = img.height;
            };
            img.src = tempCanvas.toDataURL();
        }
        
        // Apply resize to image
        function applyResize() {
            if (!currentImage) return;
            
            const newWidth = parseInt(resizeWidth.value);
            const newHeight = parseInt(resizeHeight.value);
            
            if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) {
                alert('Please enter valid width and height values');
                return;
            }
            
            // Create a temporary canvas for the resized image
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = newWidth;
            tempCanvas.height = newHeight;
            
            // Draw the resized image
            tempCtx.drawImage(currentImage, 0, 0, newWidth, newHeight);
            
            // Update current image and display
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                displayImage();
                
                // Update crop inputs
                cropWidth.value = img.width;
                cropHeight.value = img.height;
            };
            img.src = tempCanvas.toDataURL();
        }
        
        // Reset image to original
        function resetImage() {
            if (!originalImage) return;
            
            currentImage = originalImage;
            resetAdjustments();
            displayImage();
            
            // Hide controls
            cropControls.classList.add('hidden');
            resizeControls.classList.add('hidden');
            cropOverlay.style.display = 'none';
            
            // Reset dimension inputs
            cropWidth.value = originalImage.width;
            cropHeight.value = originalImage.height;
            resizeWidth.value = originalImage.width;
            resizeHeight.value = originalImage.height;
        }
        
        // Download edited image
        function downloadImage() {
            if (!currentImage) {
                alert('Please upload an image first');
                return;
            }
            
            const link = document.createElement('a');
            link.download = 'edited-image.png';
            link.href = canvas.toDataURL();
            link.click();
        }
        
        // Save image (placeholder for backend integration)
        function saveImage() {
            saveToCloud();
        }

        // Enhanced save function for free backend
        async function saveToCloud() {
            if (!currentImage) {
                alert('Please upload an image first');
                return;
            }

            try {
                // Show loading state
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                // Get the canvas data as base64
                const imageData = canvas.toDataURL('image/png');

                // Send to backend
                const response = await fetch(`${API_BASE_URL}/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: imageData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Create a direct link to view the image
                    const imageUrl = `${API_BASE_URL}${result.url}`;
            
                    // Show success message with options
                    const userChoice = confirm(
                        `Image saved successfully!\n\n` +
                        `Filename: ${result.filename}\n` +
                        `Size: ${(result.size / 1024).toFixed(2)} KB\n\n` +
                        `Click OK to view the image, or Cancel to continue editing.`
                    );
            
                    if (userChoice) {
                        // Open the image in a new tab
                        window.open(imageUrl, '_blank');
                    }
            
                    console.log('Image saved:', result);
                } else {
                    alert(`Failed to save image: ${result.error}`);
                }

            } catch (error) {
                console.error('Error saving image:', error);
                alert('Failed to save image. Please check if the backend server is running.');
            } finally {
                // Reset button state
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save to Server';
                saveBtn.disabled = false;
            }
        }



// Function to view saved images gallery
async function viewGallery() {
    try {
        const response = await fetch(`${API_BASE_URL}/images`);
        const result = await response.json();
        
        if (result.success && result.images.length > 0) {
            // Create a simple gallery view
            let galleryHTML = '<h3>Your Saved Images</h3><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 400px; overflow-y: auto;">';
            
            result.images.forEach(image => {
                const imageUrl = `${API_BASE_URL}${image.url}`;
                galleryHTML += `
                    <div style="border: 1px solid #ddd; padding: 5px; text-align: center;">
                        <img src="${imageUrl}" style="max-width: 100px; max-height: 100px;" alt="${image.filename}">
                        <div style="font-size: 12px; margin-top: 5px;">
                            ${image.filename}<br>
                            ${image.size_mb} MB
                        </div>
                        <button onclick="window.open('${imageUrl}', '_blank')" style="font-size: 12px; padding: 2px 5px; margin: 2px;">View</button>
                    </div>
                `;
            });
            
            galleryHTML += '</div>';
            
            // Show in a dialog
            const galleryDialog = document.createElement('div');
            galleryDialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 80%;
                max-height: 80%;
                overflow: auto;
            `;
            galleryDialog.innerHTML = galleryHTML + '<br><button onclick="this.parentElement.remove()" style="padding: 5px 10px;">Close</button>';
            document.body.appendChild(galleryDialog);
        } else {
            alert('No saved images found.');
        }
    } catch (error) {
        console.error('Error loading gallery:', error);
        alert('Failed to load gallery. Please check if the backend server is running.');
    }
}

// Function to check server status
async function checkServerStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}/health`);
        const result = await response.json();
        console.log('Server status:', result);
        return result.status === 'healthy';
    } catch (error) {
        console.error('Server is not running:', error);
        return false;
    }
}

// Add gallery button to your editor controls (optional)
function addGalleryButton() {
    const galleryBtn = document.createElement('button');
    galleryBtn.className = 'control-btn';
    galleryBtn.innerHTML = '<i class="fas fa-images"></i> Gallery';
    galleryBtn.onclick = viewGallery;
    
    const editorControls = document.querySelector('.editor-controls');
    editorControls.appendChild(galleryBtn);
}

// Initialize gallery button when page loads
document.addEventListener('DOMContentLoaded', function() {
    addGalleryButton();
    
    // Check server status on load
    checkServerStatus().then(isRunning => {
        if (!isRunning) {
            console.warn('Backend server is not running. Save functionality will not work.');
        }
    });
});
        
        // Initialize the application
        init();
    </script>
</body>
</html>